<div class="tabcont">
    <button tab="report" class="tab tab-active">Report</button>
    <button tab="request" class="tab">Request <div class="notif"></div></button>
</div>
<table>
    <thead></thead>
    <tbody id="reporttable" style="cursor: pointer!important"></tbody>
</table>
<div id="summary" hidden class="mt-30">
    <div class="col-4 home">
        <h3 class="title">Summary</h3>
    </div>
    <div class="card">
        <div class="f-width text-right">
            <button id="response" class="btn-primary">Ask help</button>
            <button id="repres" class="btn-danger">Respond</button>
        </div>
        <p></p>
        <div class="f-width text-center" style="caret-color: transparent">
            <img style="width:50%; border-radius: 4px;" id="img-report" alt="">
        </div>
    </div>
</div>

<script>
    $(function(){
        let aid = 0,
        ctable = ()=>{
            $("tbody>tr").click(function(){
                $("#img-report").attr("src","")
                $('.tractive').removeClass('tractive')
                $(this).attr('class','tractive')
                aid = $(this).attr('value')
                $("#summary")
                .show()
                .children('.card')
                .children('p')
                .text($(this).children().eq(4).text())
                if($(this).children().eq(5).text() != ""){
                    $("#img-report").attr("src",$(this).children().eq(6).text())
                }
            })
        },
        hidetab = ()=>{
            $("tbody>tr").click(function(){
                $(".modal").css({
                    "display":"flex",
                    "justify-content":"center",
                })
                console.log($(this).children().eq(6).text())
                $(".modal-head").children('h4').text('Details')
                $(".modal-body").html('<p>'+$(this).children().eq(5).text()+'</p>'+
                '<img src="'+$(this).children().eq(6).text()+'"/>')
            })
            $(".tabcont").hide()
        },
        fetch = (type)=>{
            console.log("exmaple")
            $.ajax({
                url:"route/getReport",
                dataType: "JSON",
                type: 'POST',
                data: {type: type},
                success: function(result){
                    $("table>thead").html(result.thead)
                    $("table>tbody").html(result.tbody)
                    result.clickable ? ctable() : hidetab()
                },
                error: function (request, status, error) {
                    console.log(request.responseText);
                }
            })
        }, 
        response = ()=>{
            console.log("response")
            $.ajax({
                url: "route/getAvailable",
                success: function(data){
                    data += "<div class='f-width text-right mt-10 mb-5'><button id='deploy' class='btn-danger'>Deploy</button></div>"
                    $(".modal-body").html(data)
                    $("#vehicle").children().each(function(){
                        $(this).click(function(){
                            if($(this).attr('class') != 'row-active'){
                                $(this).attr('class','row-active')
                                .children()
                                .children()
                                .children().text('✅').attr('class','check')
                            }else{
                                $(this).attr('class','')
                                .children()
                                .children()
                                .children().text('❏').attr('class','')
                            }
                        })
                    })

                    $(".bc").children().each(function(){
                        let b = true
                        $(this).click(function(){
                            if(b){
                                b = false
                                $(this).children().addClass('t-active')
                            }else{
                                b = true
                                $(this).children().removeClass('t-active')
                            }
                        })
                    })

                    $("#deploy").click(function(){
                        if($(".row-active").length == 0 || $(".t-active").length == 0){
                            swal.fire('Sorry!','Due to the lack of a team or vehicle, we are unable to provide service.','error')
                        }else{
                            $(".t-active").each(function(){
                                ajaxPost({url: 'route/rteam', data: {tid: $(this).attr('value'), aid: aid}})
                            })
                            $(".row-active").each(function(){
                                ajaxPost({url: 'route/rveh', data: {id: $(this).attr('value'), aid: aid}})
                            })

                            ajaxPost({url: 'route/response', data: {id: aid}})
                            $(".close-modal").click()
                            swal.fire('The team will be sent out.')
                        }
                    })
                }
            })
            return {width: '40%', text: 'Team & Vehicle available'}
        },
        ajaxPost = (p)=>{
            $.ajax({
                url: p.url,
                type: 'POST',
                data: p.data
            })
        },
        askhelp = ()=>{
            $.ajax({
                url: 'route/askhelp',
                success: function(result){
                    $(".modal-body").html(result+
                        "<div class='f-width text-right mt-10 mb-5'><button class='btn-primary' id='help'>Submit</button></div>")
                    $("#municipality").children().each(function(){
                        $(this).click(()=>{
                            if($(this).attr('class') != 'municipality-active'){
                                $(this).attr('class','municipality-active')
                                .children()
                                .children()
                                .children().text('✅').attr('class','check')
                            }else{
                                $(this).attr('class','')
                                .children()
                                .children()
                                .children().text('❏').attr('class','')
                            }
                        })
                    })
                    $("#help").click(()=>{
                        $(".municipality-active").each(function(){
                            $.ajax({
                                url: 'route/sendrequest',
                                type: 'POST',
                                data: {id: $(this).attr('value')}
                            })
                        })
                        swal.fire({
                            icon: 'success',
                            title: 'The request for help has been sent'
                        })
                        $(".close-modal").click()
                    })
                }
            })
            return {width: '25%', text: 'Ask for the help of this municipality'}
        },
        modal = (type)=>{
            const get = type ? response() : askhelp()
            $(".modal").css({"display":"flex","justify-content":"center"}).children().css('width',get.width)
            $(".modal-head>h4").text(get.text)
        }

        fetch(0)
        $(".tab").click(function(){
            $(".tab-active").removeClass('tab-active')
            $("#summary").hide()
            $(this).addClass('tab-active')
            if($(this).attr('tab') == 'report'){
                $("#response").text('Ask help')
                $("#repres").show()
                fetch(0)
            }else{
                $("#response").text('Respond')
                $("#repres").hide()
                fetch(1)
            }
        })
        
        $("#repres").click(()=>{
            modal(true)
        })

        $("#response").click(function(){
            modal($(this).text() == 'Respond')
        })
    })
</script>