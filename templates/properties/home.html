<div class="card">
    <form method="">
        <div class="row hv-center">
            <div class="form-group">
                <h3 class="grid-title">Disaster</h3>
                <input type="text" required name="disaster" class="cont-row form-control">
            </div>
            <div class="form-group">
                <h3 class="grid-title">Location</h3>
                <input type="text" required name="location" class="cont-row form-control">
            </div>
            <div class="form-group">
                <h3 class="grid-title">Date</h3>
                <input type="date" name="date" class="cont-row form-control">
            </div>
            <button class="btn-primary" style="padding: 4px 17px">Submit</button>
        </div>
        <div class="flex-col">
            <h3 class="grid-title">Summary</h3>
            <textarea name="summary" class="form-control txtarea"></textarea>
        </div>
        <div class="flex-col mb-5" id="available"></div>
        <div class="flex-col mt-10">
            <div class="img-wrapper">
                <img alt="" id="summaryimg">
                <input type="text" name="image" hidden id="imgtext">
                <input type="file" hidden accept="image/png, image/gif, image/jpeg" id="default-btn">
                <button type="button" id="custom-btn">Choose an image</button>
            </div>
        </div>
    </form>
</div>
<div class="row">
    <div id="activity" class="col-4 home">
        <h3 class="title">RECENT ACTIVITY</h3>
    </div>
    <div id="location" class="col-4 home">
        <h3 class="title">LOCATION</h3>
    </div>
    <div id="date" class="col-4 home">
        <h3 class="title">DATE OF INCIDENT</h3>
    </div>
</div>
<div class="row wrap img-cont">
</div>
<script>
    $(function(){
        // üëâÔ∏èüëáÔ∏èüëàÔ∏è
        const clearform = ()=>{
            $(".form-control").each(function(){
                $(this).val("")
                $("#summaryimg").attr("src","")
                $("#imgtext").val("")
            })
            $('input[name="date"]').val(today)
            $(".txtarea").css("height","26px")
        },
        available = ()=>{
            $.ajax({
            url: 'route/getAvailable',
            success: function(e){
                $("#available").html(e)
                $("#vehicle").children().each(function(){
                        $(this).click(function(){
                            if($(this).attr('class') != 'row-active'){
                                $(this).attr('class','row-active')
                                .children()
                                .children()
                                .children().text('‚úÖ').attr('class','check')
                            }else{
                                $(this).attr('class','')
                                .children()
                                .children()
                                .children().text('‚ùè').attr('class','')
                            }
                        })
                    })

                    $(".bc").children().each(function(){
                        let b = true
                        $(this).click(function(){
                            if(b){
                                b = false
                                $(this).children().addClass('t-active')
                            }else{
                                b = true
                                $(this).children().removeClass('t-active')
                            }
                        })
                    })
            }
        })
        }
        available()
        $("#custom-btn").click(function(){
            $("#default-btn").click()
        })
        
        $("#default-btn").change(function(){
            const file = this.files[0]
            if(file){
                const reader = new FileReader()
                reader.onload = function(){
                    const result = reader.result
                    $("#summaryimg").attr("src",result)
                    $("#imgtext").val(result)
                }
                reader.readAsDataURL(file)
            }
        })
        function msg(type,msg){
            $("body").append("<div class='alert'><div class='"+type+"'><a>"+msg+"</a></div></div>")
            setTimeout(()=>{
                $(".alert").css("opacity","0")
            },1700)
            setTimeout(()=>{
                $(".alert").remove()
            },3000)
        }
        
        $(".txtarea").each(function () {
            this.setAttribute("style", "height:" + (this.scrollHeight) + "px;overflow-y:hidden;")
        }).on("input", function () {
            this.style.height = 0
            this.style.height = (this.scrollHeight) + "px"
        })
        var now = new Date()
        var month = (now.getMonth() + 1)               
        var day = now.getDate()
        if (month < 10) 
            month = "0" + month
        if (day < 10) 
            day = "0" + day
        var today = now.getFullYear() + '-' + month + '-' + day
        $('input[name="date"]').val(today)
        $.ajax({
            url: "route/aclist",
            dataType: "JSON",
            success: function(result){
                $("#activity").append(result.activity)
                $("#location").append(result.location)
                $("#date").append(result.date)
                $(".img-cont").append(result.image)
                result.selfMun ? $(".card").show() : $(".card").hide()
            }
        })
        $("form").submit(function(e){
            e.preventDefault()
            const data = new FormData(this)
            if($(".row-active").length == 0 || $(".t-active").length == 0){
                swal.fire({
                    title: 'Sorry!',
                    html: '<h5 style="margin: 0">Due to the lack of a team or vehicle, we are unable to provide service.</h5>',
                    icon: 'error',
                    showCancelButton: true,
                    confirmButtonText: 'ask help'
                }).then((result)=>{
                    if(result.isConfirmed){
                        $(".modal-form").width("25%")
                        $(".modal-head").children('h4').text('Ask for the help of this municipality')
                        $.ajax({
                            url: 'route/askhelp',
                            success: function(result){
                                $(".modal-body").html(result+
                                "<div class='f-width text-right mt-10 mb-5'><button class='btn-primary' id='help'>Submit</button></div>")
                                $("#municipality").children().each(function(){
                                    $(this).click(()=>{
                                        if($(this).attr('class') != 'municipality-active'){
                                            $(this).attr('class','municipality-active')
                                            .children()
                                            .children()
                                            .children().text('‚úÖ').attr('class','check')
                                        }else{
                                            $(this).attr('class','')
                                            .children()
                                            .children()
                                            .children().text('‚ùè').attr('class','')
                                        }
                                    })
                                })
                                $("#help").click(()=>{
                                    insertact(false,data)
                                    $(".municipality-active").each(function(){
                                        $.ajax({
                                            url: 'route/sendrequest',
                                            type: 'POST',
                                            data: {id: $(this).attr('value')}
                                        })
                                    })
                                    swal.fire({
                                        icon: 'success',
                                        title: 'The request for help has been sent'
                                    })
                                    $(".close-modal").click()
                                    clearform()
                                })
                            }
                        })
                        $(".modal").css({
                            "display":"flex",
                            "justify-content":"center",
                        })
                    }
                })
            }else{
                insertact(true,data)
            }
        })

        function insertact(b,data){
            $.ajax({
                url: "route/inAc",
                type: "POST",
                data: data,
                dataType: "JSON",
                contentType: false,
                cache: false,
                processData: false,
                success: function(r){
                    if(b) r.success ? success(r.id) : msg("aerror","Sorry we have a problem about the database connection")
                }
            })
        }
        function success(aid){
            $(".t-active").each(function(){
                $.ajax({
                    url: 'route/rteam',
                    type: "POST",
                    data: {tid: $(this).attr('value'), aid: aid}
                })
            })
            $(".row-active").each(function(){
                $.ajax({
                    url: 'route/rveh',
                    type: "POST",
                    data: {id: $(this).attr('value'), aid: aid}
                })
            })
            msg("asuccess","The report has been sent") 
            clearform()
            available()
        }
    })
</script>